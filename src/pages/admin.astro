---
import BaseLayout from '../layouts/BaseLayout.astro';
import AdminStats from '../components/AdminStats.astro';
import seedReservations from '../data/reservations.json';
import seedMemberships from '../data/memberships.json';
import seedClasses from '../data/classes.json';
---
<BaseLayout title="Admin | IronStack Range Demo">
  <h1 class="mb-2 text-3xl font-bold text-white">Operations Dashboard</h1>
  <p class="mb-6 text-slate-400">Real-time operational intelligence for range owners.</p>
  <div id="admin-gate" class="card p-6 text-center">
    <p class="mb-4">Admin PIN required.</p>
    <button id="unlock-btn" class="btn-primary">Unlock Dashboard</button>
  </div>
  <div id="admin-content" class="hidden">
    <AdminStats />
  </div>
</BaseLayout>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script define:vars={{ seedReservations, seedMemberships, seedClasses }}>
  const PIN = '1234';
  const authKey = 'adminAuthed';

  const read = (key, fallback = []) => JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback));

  const ensureSeed = () => {
    if (!localStorage.getItem('reservations')) localStorage.setItem('reservations', JSON.stringify(seedReservations));
    if (!localStorage.getItem('activeMemberships')) {
      const seeded = seedMemberships.map((m, i) => ({ id: `MEM-SEED-${i+1}`, tier: m.tier, startedAt: new Date().toISOString() }));
      localStorage.setItem('activeMemberships', JSON.stringify(seeded));
    }
    if (!localStorage.getItem('classRegistrations')) {
      const seeded = seedClasses.slice(0, 3).map((c, i) => ({ id: `CLS-SEED-${i+1}`, title: c.title, createdAt: new Date().toISOString() }));
      localStorage.setItem('classRegistrations', JSON.stringify(seeded));
    }
  };

  const render = () => {
    const reservations = read('reservations', seedReservations);
    const memberships = read('activeMemberships', []);
    const classRegs = read('classRegistrations', []);

    document.getElementById('stat-reservations').textContent = reservations.length;
    document.getElementById('stat-memberships').textContent = memberships.length;
    document.getElementById('stat-classes').textContent = classRegs.length;

    const revenue = reservations.length * 35 + memberships.length * 89 + classRegs.length * 120;
    document.getElementById('stat-revenue').textContent = `$${revenue.toLocaleString()}`;

    const occupancy = Math.min(100, Math.round((reservations.length / 30) * 100));
    document.getElementById('occupancy-bar').style.width = `${occupancy}%`;
    document.getElementById('occupancy-text').textContent = `${occupancy}% occupied`;

    const tbody = document.getElementById('recent-body');
    tbody.innerHTML = reservations.slice(0, 6).map((r) => `<tr class="border-b border-slate-800"><td class="py-2">${r.id}</td><td>${r.date || 'N/A'} ${r.time || ''}</td><td>${r.laneType || 'Pistol'}</td></tr>`).join('');

    const data = [Math.round(revenue * 0.55), Math.round(revenue * 0.7), Math.round(revenue * 0.85), revenue];
    const ctx = document.getElementById('revenue-chart');
    if (window.Chart && ctx) {
      new Chart(ctx, {
        type: 'line',
        data: { labels: ['Q1', 'Q2', 'Q3', 'Q4'], datasets: [{ label: 'Revenue', data, borderColor: '#ef4444', tension: 0.35 }] },
        options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } } }
      });
    }
  };

  document.getElementById('export-csv')?.addEventListener('click', () => {
    const rows = read('reservations', []).map((r) => [r.id, r.date, r.time, r.laneType, (r.addons || []).join('|')]);
    const csv = [['ID', 'Date', 'Time', 'Lane Type', 'Add-ons'], ...rows].map((r) => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reservations-export.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('reset-demo')?.addEventListener('click', () => {
    ['reservations', 'activeMemberships', 'classRegistrations', 'waivers', 'lastSuccess'].forEach((k) => localStorage.removeItem(k));
    ensureSeed();
    render();
  });

  const unlock = () => {
    const pin = prompt('Enter Admin PIN');
    if (pin === PIN) {
      sessionStorage.setItem(authKey, 'yes');
      document.getElementById('admin-gate').classList.add('hidden');
      document.getElementById('admin-content').classList.remove('hidden');
      ensureSeed();
      render();
    } else if (pin) {
      alert('Invalid PIN');
    }
  };

  document.getElementById('unlock-btn')?.addEventListener('click', unlock);

  if (sessionStorage.getItem(authKey) === 'yes') {
    document.getElementById('admin-gate').classList.add('hidden');
    document.getElementById('admin-content').classList.remove('hidden');
    ensureSeed();
    render();
  }
</script>
